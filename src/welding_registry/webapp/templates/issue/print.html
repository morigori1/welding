<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>{{ title or '資格発行 印刷' }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root { color-scheme: light; }
      @page { size: A4 {% if orientation == 'landscape' %}landscape{% else %}portrait{% endif %}; margin: 12mm; }

      body { font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin:0; background:#f4f4f4; }
      .toolbar { padding:10px 16px; background:#fefefe; border-bottom:1px solid #ccc; display:flex; align-items:center; gap:16px; }
      .toolbar a { color:#0366d6; text-decoration:none; }
      .toolbar button { padding:6px 12px; border:1px solid #999; background:#fff; cursor:pointer; }
      .toolbar button:hover { background:#eee; }
      .toolbar .spacer { flex:1 1 auto; }
      @media print {
        .toolbar { display:none; }
        body { background:#fff; margin:0; }
      }
      .issue-pages { padding:12px; }
      .issue-page { background:#fff; margin:0 auto 16px; padding:12mm; width:210mm; min-height:270mm; box-sizing:border-box; page-break-after:always; box-shadow:0 0 6px rgba(0,0,0,0.1); }
      @media print {
        .issue-page { box-shadow:none; width:auto; min-height:auto; padding:0; }
      }
      .issue-page-head { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px; font-size:12px; }
      .issue-page-title { font-size:16px; font-weight:600; }
      .issue-page-meta { color:#555; }
      .issue-table { border-collapse:collapse; width:100%; font-size:12px; }
      .issue-table th, .issue-table td { border:1px solid #999; padding:4px 6px; }
      .issue-table th { background:#f2f2f2; }
      .archive-status { margin:12px 16px; padding:8px 12px; border-radius:4px; font-size:13px; display:none; }
      .archive-status[data-status="success"] { border:1px solid #2b8a3e; background:#e6f4ea; color:#1b5e20; }
      .archive-status[data-status="error"] { border:1px solid #c92a2a; background:#fdecef; color:#842029; }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <a href="{{ preview_url }}">← プレビューに戻る</a>
      <div>行/頁: {{ rows_per_page }} ・ 方向: {{ '縦' if orientation == 'portrait' else '横' }} ・ 更新: {{ generated_at }}</div>
      <div class="spacer"></div>
      <button type="button" id="pdf-save-button">PDF保存</button>
      <button type="button" onclick="window.print()">印刷</button>
    </div>
    <div id="archive-status" class="archive-status"></div>
    {% if pages %}
      {% include "issue/pages.html" %}
    {% else %}
      <p style="margin:24px">印刷対象がありません。</p>
    {% endif %}
    <script>
      (function () {
        const archiveUrl = "{{ archive_url }}";
        const archiveBasePayload = {{ archive_payload|tojson }};
        const statusBox = document.getElementById("archive-status");
        const pdfButton = document.getElementById("pdf-save-button");
        if (!pdfButton) {
          return;
        }
        let pendingArchive = false;

        function showStatus(kind, message) {
          if (!statusBox) {
            return;
          }
          statusBox.dataset.status = kind;
          statusBox.textContent = message;
          statusBox.style.display = "block";
        }

        function clonePayload() {
          return JSON.parse(JSON.stringify(archiveBasePayload));
        }

        function sendArchive() {
          const payload = clonePayload();
          payload.printed_at = new Date().toISOString();
          fetch(archiveUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((resp) =>
              resp.json().then((body) => ({
                ok: resp.ok,
                body,
              }))
            )
            .then(({ ok, body }) => {
              if (ok) {
                const pid = body.print_id ? ` #${body.print_id}` : "";
                showStatus("success", `印刷履歴${pid}として保存しました。`);
              } else {
                showStatus("error", body && body.error ? body.error : "印刷履歴の保存に失敗しました。");
              }
            })
            .catch(() => {
              showStatus("error", "印刷履歴の保存に失敗しました。");
            });
        }

        pdfButton.addEventListener("click", () => {
          pendingArchive = true;
          window.print();
        });

        window.addEventListener("afterprint", () => {
          if (!pendingArchive) {
            return;
          }
          pendingArchive = false;
          sendArchive();
        });
      })();
    </script>
  </body>
</html>
